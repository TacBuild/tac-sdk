# SDK Senders

Senders are responsible for signing and broadcasting the TON-side transactions generated by the SDK. The SDK uses the `SenderAbstraction` interface to allow different sending mechanisms.

**Table of Contents**

- [SDK Senders](#sdk-senders)
  - [`SenderAbstraction` (Interface)](#senderabstraction-interface)
  - [`TonConnectSender`](#tonconnectsender)
  - [`RawSender`](#rawsender)
  - [`SenderFactory`](#senderfactory)

## `SenderAbstraction` (Interface)

Defines the contract for any object that can send transactions for the TacSdk.

**Purpose**

- Provides a consistent way for `TacSdk.sendCrossChainTransaction` to interact with different wallet implementations (like TonConnect or a raw private key).

**Methods**

- `sendShardTransaction(shardTransaction: ShardTransaction, delay: number, chain?: Network, contractOpener?: ContractOpener): Promise<unknown>`:
  - Takes a prepared `ShardTransaction` (containing messages, value, destination) and sends it.
  - `delay`: A delay (in seconds) to wait before performing operations, used to avoid rate limits.
  - `chain` (Network, optional): The target network.
  - `contractOpener` (ContractOpener, optional): Needed by some senders (like `RawSender`) to interact with the wallet contract.
  - Returns a promise that resolves with the result of the send operation (the specific type depends on the implementation, e.g., `SendTransactionResponse` for TonConnect).
- `getSenderAddress(): string`:
  - Returns the TON address of the wallet associated with the sender.

**Usage**

You typically don't interact with this interface directly, but rather use one of its implementations (`TonConnectSender` or `RawSender`), often created via `SenderFactory`.

## `TonConnectSender`

An implementation of `SenderAbstraction` that uses the TonConnect UI library to propose transactions to the user's connected wallet (e.g., Tonkeeper, OpenMask).

**Purpose**

- Integrates with the standard TonConnect flow, allowing users to confirm transactions securely in their preferred wallet app.

**Constructor**

- `constructor(tonConnect: TonConnectUI)`: Takes an initialized `TonConnectUI` instance as input.

**Methods**

- `sendShardTransaction(...)`: Implements the interface method by formatting the transaction request and calling `tonConnect.sendTransaction()`. Returns `Promise<SendTransactionResponse>` from `@tonconnect/sdk`.
- `getSenderAddress()`: Implements the interface method by returning the address from the connected `tonConnect` instance.

```ts
import { TonConnectUI } from '@tonconnect/ui';
import { TonConnectSender, TacSdk, Network } from '@tonappchain/sdk';

// 1. Initialize TonConnectUI (refer to TonConnect documentation)
const tonConnectUI = new TonConnectUI({
    manifestUrl: 'https://<YOUR_APP_URL>/tonconnect-manifest.json',
    buttonRootId: 'ton-connect-button' // Example ID
});

// Wait for connection if necessary
// await tonConnectUI.connectWallet();

// 2. Create the sender
const sender = new TonConnectSender(tonConnectUI);

// 3. Use the sender with TacSdk
async function main() {
  const sdk = await TacSdk.create({ network: Network.TESTNET });
  const evmProxyMsg = { /* ... your EVM message ... */ };

  if (sender.getSenderAddress()) { // Check if wallet is connected
    const txLinker = await sdk.sendCrossChainTransaction(evmProxyMsg, sender);
    console.log('Transaction sent via TonConnect, Linker:', txLinker);
  } else {
    console.log('Please connect wallet first.');
  }
}

main(); 
```

## `RawSender`

An implementation of `SenderAbstraction` that sends transactions directly using a raw private key. This is suitable for backend applications or testing where user interaction via TonConnect is not possible or desired.

**Purpose**

- Allows programmatic sending of transactions without user confirmation prompts.
- Requires direct access to the wallet's private key.

**Constructor**

- `constructor(wallet: WalletInstance, secretKey: Buffer)`:
  - `wallet` (WalletInstance): An instance of a wallet contract conforming to the `WalletInstance` interface defined in `SenderAbstraction.ts` (typically an instance of a wallet contract class from `@ton/ton`, like `WalletContractV4`, created with the corresponding public key).
  - `secretKey` (Buffer): The raw private key corresponding to the wallet.

**Methods**

- `sendShardTransaction(...)`: Implements the interface method by fetching the wallet's sequence number (`seqno`), preparing the internal messages, and calling the wallet contract's `sendTransfer` method with the secret key. Returns `Promise<void>`.
- `getSenderAddress()`: Implements the interface method by returning the address of the provided `wallet` instance.

**Security Note:** Handling raw private keys requires extreme care. Never expose them in client-side code.

```ts
import { mnemonicToWalletKey } from 'ton-crypto';
import { WalletContractV4 } from '@ton/ton';
import { RawSender, SenderFactory, TacSdk, Network, WalletVersion } from '@tonappchain/sdk';

// WARNING: Never hardcode mnemonics in production code. Use environment variables or secure config management.
const mnemonic = process.env.YOUR_MNEMONIC; // Example: load from environment
const network = Network.TESTNET;

async function main() {
  if (!mnemonic) {
    console.error('Mnemonic not found. Set YOUR_MNEMONIC environment variable.');
    return;
  }

  // 1. Create the sender (using SenderFactory is often easier, see below)
  const keyPair = await mnemonicToWalletKey(mnemonic.split(' '));
  const workchain = 0; // Usually 0
  const wallet = WalletContractV4.create({ workchain, publicKey: keyPair.publicKey });
  const sender = new RawSender(wallet, keyPair.secretKey);
  
  // Or using SenderFactory (Recommended for RawSender creation):
  // const sender = await SenderFactory.getSender({
  //   network: network,
  //   version: 'V4', // Specify your wallet version
  //   mnemonic: mnemonic 
  // });

  console.log('Using sender address:', sender.getSenderAddress());

  // 2. Use the sender with TacSdk
  const sdk = await TacSdk.create({ network });
  const evmProxyMsg = { /* ... your EVM message ... */ };

  try {
    const txLinker = await sdk.sendCrossChainTransaction(evmProxyMsg, sender);
    console.log('Transaction sent via RawSender, Linker:', txLinker);
  } catch (error) {
    console.error('Failed to send raw transaction:', error);
  }
}

main();
```

## `SenderFactory`

A utility class to simplify the creation of `SenderAbstraction` instances.

**Purpose**

- Provides a single static method (`getSender`) to create either a `TonConnectSender` or a `RawSender` based on the provided parameters.
- Handles the complexity of deriving keys and creating the correct wallet contract instance for `RawSender`.

**Static Methods**

- `static async getSender(params): Promise<SenderAbstraction>`:
  - Takes a `params` object which can be one of two types:
    1.  `{ tonConnect: TonConnectUI }`: If a `TonConnectUI` instance is provided, it returns a `TonConnectSender`.
    2.  `{
          network: Network;
          version: WalletVersion;
          mnemonic: string;
          options?: { /* wallet-specific options */ };
        }`: If network, wallet version, and mnemonic are provided, it derives the keys, creates the appropriate `WalletInstance` (handling different versions), and returns a configured `RawSender`.
        - `WalletVersion`: A string literal type specifying the wallet contract version:
          - `'V2R1'`, `'V2R2'`: TON wallet contract v2 (older versions)
          - `'V3R1'`, `'V3R2'`: TON wallet contract v3
          - `'V4'`: Most common TON wallet contract version
          - `'V5R1'`: Newer version with subwallet support
          - `'HIGHLOAD_V3'`: Special version for high-load scenarios
        - `options`: Optional parameters specific to certain wallet versions:
          - For V5R1: `{ v5r1: { subwalletNumber?: number } }`
          - For HIGHLOAD_V3: `{ highloadV3: { subwalletId?: number, timeout?: number } }`

**Returns**

- `Promise<SenderAbstraction>`: A promise resolving to the created sender instance (`TonConnectSender` or `RawSender`).

**Throws**

- `UnknownWalletError`: If an unsupported `WalletVersion` is provided for RawSender creation.
- Errors from `mnemonicToWalletKey` if the mnemonic is invalid.

```ts
import { TonConnectUI } from '@tonconnect/ui';
import { SenderFactory, Network, WalletVersion } from '@tonappchain/sdk';

async function createSenders() {
  // Example 1: Creating a TonConnectSender
  const tonConnectUI = new TonConnectUI({ /* ... manifest ... */ });
  const tcSender = await SenderFactory.getSender({ tonConnect: tonConnectUI });
  console.log('TonConnectSender created. Address:', tcSender.getSenderAddress());

  // Example 2: Creating a RawSender (V4 wallet)
  const mnemonic = process.env.YOUR_MNEMONIC_V4; 
  if (mnemonic) {
    const rawSenderV4 = await SenderFactory.getSender({
      network: Network.TESTNET,
      version: 'V4', 
      mnemonic: mnemonic
    });
    console.log('RawSender (V4) created. Address:', rawSenderV4.getSenderAddress());
  } else {
    console.warn('Skipping RawSender V4 example: YOUR_MNEMONIC_V4 not set.');
  }
  
  // Example 3: Creating a RawSender (Highload V3 wallet with options)
  const hlMnemonic = process.env.YOUR_MNEMONIC_HL;
  if (hlMnemonic) {
    const rawSenderHL = await SenderFactory.getSender({
      network: Network.TESTNET,
      version: 'HIGHLOAD_V3', 
      mnemonic: hlMnemonic,
      options: {
        highloadV3: { subwalletId: 123, timeout: 60000 }
      }
    });
    console.log('RawSender (Highload) created. Address:', rawSenderHL.getSenderAddress());
  } else {
     console.warn('Skipping RawSender Highload example: YOUR_MNEMONIC_HL not set.');
  }
}

createSenders();
``` 